# Developer Platform · CLI Submodule

- **Author**: CLI Working Group
- **Date**: 2024-05-27
- **Scope**: Submodule `developer_platform/cli` channel `workflows`. Defines behaviour for the Python-based CLI that executes runtime workflows using Solar Fire, Swiss Ephemeris, and indexed dataset assets.

## Inputs

| Input | Location | Notes |
|-------|----------|-------|
| OpenAPI schema | `openapi/v{major}.{minor}.json` | Drives autogenerated command help and parameter validation. |
| Dataset indices | `datasets/index/*.json` | Map Solar Fire CSVs, SQLite tables, and ephemeris caches to CLI selectors. |
| Profiles & rulesets | `profiles/*.yaml`, `rulesets/**/*.yaml` | Provide defaults for CLI options and severity thresholds. |
| Registry metadata | `astroengine/modules/**/registry.yaml` | Ensures module → submodule → channel linkage remains intact. |

## Outputs

- Python package `astro-cli` (PyPI) exposing the `astro` console script.
- Shell completions (`bash`, `zsh`, `fish`) generated via `typer`/`click` integration.
- Structured JSON/CSV/ICS exports stored under user-specified paths, each including provenance fields referencing Solar Fire export hashes or Swiss Ephemeris build numbers.

## Command Surface

| Command | Description | Primary Data Sources |
|---------|-------------|----------------------|
| `astro scan aspects` | Batch aspects search across Solar Fire-derived datasets. | Solar Fire CSV exports, Swiss Ephemeris cache. |
| `astro events detect` | Run detector suite over transit feeds, returning typed JSON. | Swiss Ephemeris cache, natal chart registries. |
| `astro election find` | Evaluate election windows using ruleset DSL and profile defaults. | Rulesets YAML, Solar Fire sample charts. |
| `astro progressions secondary` | Generate progressed charts tied to natal dataset records. | Solar Fire natal indices, Swiss Ephemeris cache. |
| `astro returns scan` | Compute solar/lunar returns across year ranges. | Solar Fire natal CSV, Swiss Ephemeris cache. |
| `astro export ics` | Convert JSON results into calendar events with severity metadata. | CLI output JSON, ICS schema from `docs/module/interop.md`. |

All commands must support:

- `--api-key` / `--oidc-token` authentication, deferring to environment variables or OS keychain when omitted.
- `--timeout` (seconds) and `--max-retries` (default 5) options applying exponential backoff with jitter identical to SDK policies.
- `--idempotency-key` for POST-like workflows (e.g., remote analysis jobs) to maintain replay safety.
- Pagination helpers for endpoints returning cursor-based results, surfaced as iterables or incremental JSONL writes.

## Architecture

- Implemented with `click` layered over shared runtime modules within `astroengine/` to avoid duplicating business logic.
- HTTP interactions reuse the Python SDK client configured for CLI telemetry (User-Agent `AstroEngineCLI/<version>` plus dataset tags).
- Local caching leverages `~/.cache/astroengine/` with checksums referencing dataset source hashes to ensure reproducibility.
- Configuration file: `~/.config/astro/config.toml` storing defaults (profile IDs, dataset selectors). Documented defaults must align with Solar Fire dataset indices.

## Observability & Security

- Structured logs emitted via `rich`/`structlog` include `module`, `submodule`, `channel`, `command`, `request_id`, and dataset identifiers.
- Metrics optionally exported to stdout in OpenMetrics format for integration tests.
- Webhook signature verification helper available via `astro webhooks verify --secret-file <path> --payload-file <path>` (delegates to `developer_platform/webhooks`).
- Secrets never written to disk; API keys pulled from keychain or environment variables and masked in logs.

## Testing Strategy

1. Unit tests under `sdks/python/tests/cli` use `respx` to simulate API responses based on Solar Fire fixtures.
2. Golden output tests compare CLI results to canonical CSV/JSON stored under `tests/data/cli/`, each entry referencing dataset hashes.
3. End-to-end smoke test `poetry run astro scan aspects --from 2025-01-01 --to 2025-01-07 --bodies Mars,Venus` executed against mock server seeded with Swiss Ephemeris derived NDJSON streams.
4. Contract test ensures CLI command signatures remain in sync with OpenAPI parameters; fails build if schema drift occurs.

## Acceptance Checklist

- [ ] CLI help text regenerated from frozen OpenAPI schema.
- [ ] Authentication, timeout, retry, and idempotency options verified in automated tests.
- [ ] Golden dataset comparisons updated with Solar Fire export hashes.
- [ ] Webhook verification workflow documented and tested.
- [ ] Release notes capture CLI version, schema hash, and dataset versions.
