# Developer Platform Â· SDKs Submodule

- **Author**: SDK Working Group
- **Date**: 2024-05-27
- **Scope**: Submodule `developer_platform/sdks` covering TypeScript and Python SDK channels. Operates on OpenAPI payloads generated from the live FastAPI service and validated against Solar Fire and Swiss Ephemeris datasets tracked in the repository.

## Inputs

| Input | Location | Notes |
|-------|----------|-------|
| Versioned OpenAPI schema | `openapi/v{major}.{minor}.json` | Frozen per API release; checksum recorded in release manifest. |
| Solar Fire validation exports | `datasets/solarfire/exports/*.csv` | Used to confirm example responses and severity calculations; never synthesised. |
| Swiss Ephemeris cache | `datasets/sweph/` | Provides planetary positions for regression fixtures referenced in documentation. |
| Ruleset & profile registries | `profiles/*.yaml`, `rulesets/**/*.yaml` | Drive enumerations and default values surfaced by SDK helpers. |

## Outputs

| Channel | Artefact | Distribution |
|---------|----------|--------------|
| `typescript` | `@astroengine/sdk` npm package (ESM + CJS) with type declarations and tree-shakable modules. | Published via GitHub Actions to npm on tagged releases. |
| `python` | `astro-sdk` PyPI distribution (sync + async clients) built with `pydantic` models. | Published via GitHub Actions to PyPI using trusted publishing. |

## Generation Workflow

1. Pull latest schema: `curl https://api.astroengine.local/openapi.json > openapi/latest.json` and freeze to `openapi/vX.Y.json` after review.
2. Run generators:
   - TypeScript: `pnpm --filter ./sdks/typescript generate --schema ../../openapi/vX.Y.json` (executes the PNPM workspace rooted in `sdks/typescript`).
   - Python: `poetry run python scripts/generate.py --schema ../../openapi/vX.Y.json` from within `sdks/python`.
3. Inspect diffs for hand-polish areas (pagination helpers, streaming wrappers, typed error mapping). Any manual edits must document rationale in `sdks/<lang>/CHANGELOG.md` referencing dataset-backed acceptance evidence.
4. Execute contract tests using Prism mock servers seeded with Solar Fire ephemeris fixtures in `generated/prism/`.
5. Record release metadata: schema hash, Solar Fire export version, Swiss Ephemeris build identifier. The generators append the fingerprints to `sdks/typescript/CHANGELOG.md` and `sdks/python/CHANGELOG.md` automatically so the artefact provenance is immutable.

## Channel Requirements

### TypeScript Channel (`typescript`)

- **Transport**: `fetch` API in browsers, `undici` in Node. Timeouts implemented via `AbortController` with default 30s.
- **Retries**: Exponential backoff with jitter (base 200ms, cap 5s) respecting `Retry-After` headers. Implemented in `src/middleware/retry.ts`.
- **Pagination**: `client.paginate(path, params)` returns async iterable handling `next` cursors automatically.
- **Streaming**: `client.stream(path, params)` yields parsed NDJSON/SSE chunks with built-in reconnect logic for idempotent `GET` endpoints.
- **Idempotency**: `client.post` accepts optional `idempotencyKey`. Helper `client.withIdempotency(key => ...)` sets scoped header.
- **Errors**: `ApiError` base class with `code`, `httpStatus`, `message`, `details`. Convenience guards `isRateLimited`, `isInvalidBody`, etc. Codes align with runtime taxonomy documented in `docs/module/ruleset_dsl.md`.
- **Build**: Rollup configuration outputs dual ESM/CJS bundles with type declarations and `sideEffects: false`. Publish metadata includes schema hash and dataset versions.

### Python Channel (`python`)

- **Transport**: `httpx.Client` and `httpx.AsyncClient` with configurable timeout (default 30s) and optional OIDC token management via cached discovery metadata (`datasets/oidc/metadata.json`).
- **Retries**: `tenacity` decorator implementing exponential backoff with full jitter (base 0.2s, cap 5s) and `Retry-After` support.
- **Pagination**: Generators in `astro_sdk.pagination` yield dictionaries parsed into `pydantic` v2 models; rely on `next` cursor fields from API.
- **Streaming**: Context manager `client.stream(...)` yielding decoded JSON objects from NDJSON streams. Async variant uses `aiter_lines`.
- **Idempotency**: Context manager `with client.idempotent(key):` attaches `Idempotency-Key` header for nested POST requests. Keys surfaced to logs for auditability.
- **Errors**: Exception hierarchy `ApiError`, `RateLimitedError`, `InvalidBodyError`, etc., each exposing `code`, `status_code`, `message`, and optional `payload`. Uses response metadata validated against Solar Fire comparisons when available.
- **Models**: Autogenerated `pydantic` models with strict typing; custom overrides allowed only when tied to documented schema quirks (recorded in `sdks/python/OVERRIDES.md`).

## Testing & QA

- Contract tests run via `pnpm --filter ./sdks/typescript test` and `poetry run pytest sdks/python/tests` using Prism mocks and httpx transports seeded with Solar Fire fixtures.
- Severity, orb, and detector enumerations validated against runtime JSON under `schemas/` to prevent drift.
- Example notebooks cross-check API responses with Solar Fire exports; stored in `sdks/python/examples/` with dataset hashes.

## Observability & Telemetry

- User-Agent string includes package name/version plus optional application tag. Example: `AstroEngineTS/1.2.0 (+solarfire-hash=abc123)`.
- SDK logs expose `request_id`, `idempotency_key`, `profile_id`, and dataset references to satisfy audit requirements.
- Metrics emitted via optional hooks allowing integrators to plug into Prometheus/OpenTelemetry.

## Acceptance Checklist

- [ ] Schema diff reviewed and frozen under `openapi/vX.Y.json`.
- [ ] Generated TypeScript and Python SDKs compile and pass tests.
- [ ] Retry, pagination, streaming, and idempotency behaviours verified against mock server and Solar Fire datasets.
- [ ] Error taxonomy validated against `docs/module/ruleset_dsl.md` and sample responses.
- [ ] Release notes updated with schema hash, dataset versions, and QA evidence.
