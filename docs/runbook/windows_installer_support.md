# Windows Installer Support Runbook

## Overview

This runbook documents the day-2 operations workflow for the AstroEngine
Windows one-click installer (SPEC-02). It is intended for support
engineers responding to installation or launch incidents reported by
operators on Windows 10/11.

Use this guide to:

- Locate and collect installer/runtime logs.
- Reproduce the issue using diagnostic commands.
- Execute supported repair flows and validate recovery.

## Triage checklist

1. **Confirm installer edition**
   - Online bootstrapper (`Setup.exe`) vs. offline bundle (`SetupOffline.exe`).
   - Capture installer version from `HKCU\Software\AstroEngine\Installer` →
     `Version` value or from the top of the latest `setup-*.log` file.
2. **Identify install scope**
   - Per-user default installs reside under
     `%LOCALAPPDATA%\AstroEngine`.
   - All-user installs (rare) live in `C:\Program Files\AstroEngine` and
     write logs under `%PROGRAMDATA%\AstroEngine`.
3. **Collect recent logs**
   - Installer logs under `%LOCALAPPDATA%\AstroEngine\logs\install`.
   - Runtime logs under `%LOCALAPPDATA%\AstroEngine\logs\runtime`.
   - Repair logs under `%LOCALAPPDATA%\AstroEngine\logs\repair`.
4. **Verify launch shortcuts**
   - Start Menu entries inside
     `%APPDATA%\Microsoft\Windows\Start Menu\Programs\AstroEngine`.
5. **Run health probe**
   - `env\Scripts\python.exe installer\windows_portal_entry.py --launch api --health-only`.
   - Confirms API boots, resolves port conflicts, and returns HTTP 200 from
     `/health`.

## Log locations & collection

| Purpose | Default path | Notes |
| --- | --- | --- |
| Setup wizard | `%LOCALAPPDATA%\AstroEngine\logs\install\setup-YYYYMMDD.log` | Created during GUI or silent installs. Rotates at 10 MB (3 archives). |
| Silent/unattended | `%LOCALAPPDATA%\AstroEngine\logs\install\silent.log` | Populated when `/VERYSILENT` used. Includes MSI exit codes. |
| Repair runs | `%LOCALAPPDATA%\AstroEngine\logs\repair\repair-YYYYMMDD.log` | Emitted by Start Menu **Repair AstroEngine** shortcut and Control Panel repairs. |
| Post-install validation | `%LOCALAPPDATA%\AstroEngine\logs\install\post_install.log` | Captures Alembic migrations and health probes. |
| Runtime API | `%LOCALAPPDATA%\AstroEngine\logs\runtime\astroengine_api.log` | Rolling logs from API launcher (port resolution + stack traces). |
| Runtime UI | `%LOCALAPPDATA%\AstroEngine\logs\runtime\astroengine_ui.log` | Streamlit diagnostics including final URL. |
| Diagnostic bundles | `%LOCALAPPDATA%\AstroEngine\logs\diag-YYYYMMDD.zip` | Generated by Start Menu **Collect Diagnostics** helper. |

### Collection commands (PowerShell)

```powershell
# Tail the most recent installer log
Get-ChildItem "$env:LOCALAPPDATA\AstroEngine\logs\install" -Filter 'setup-*.log' |
  Sort-Object LastWriteTime -Descending |
  Select-Object -First 1 |
  Get-Content -Tail 120

# Export diagnostics bundle
$bundle = Join-Path $env:LOCALAPPDATA 'AstroEngine/logs/diag-' + (Get-Date -Format 'yyyyMMddHHmmss') + '.zip'
& "$env:LOCALAPPDATA\AstroEngine\installer\CollectDiagnostics.ps1" -OutputPath $bundle
Write-Host "Bundle archived at $bundle"

# Verify runtime port assignment
Get-Content "$env:LOCALAPPDATA\AstroEngine\logs\runtime\astroengine_api.log" -Tail 40 |
  Select-String 'Resolved API port'
```

### Sample installer log excerpt

```text
2024-05-28 14:32:15Z [INFO] Begin install phase: PythonRuntime
2024-05-28 14:32:18Z [INFO] Extracted python311.zip → runtime\python311
2024-05-28 14:32:24Z [INFO] Installing wheels via pip (hash-verified)
2024-05-28 14:32:40Z [ERROR] Alembic upgrade failed: sqlite3.OperationalError: database is locked
2024-05-28 14:32:40Z [INFO] See logs\install\alembic.log for full trace
```

Use the failure banner to direct operators to the precise log referenced
in the error line. Always request the paired `alembic.log` when
migration failures occur.

## Common troubleshooting scenarios

### 1. Installer blocked by antivirus

**Symptoms:** Wizard halts during runtime extraction, logs show
`AccessDeniedException` on `%LOCALAPPDATA%\AstroEngine\runtime`.

**Actions:**

1. Confirm the antivirus product quarantined `python.exe` or wheel files.
2. Ask the operator to add `%LOCALAPPDATA%\AstroEngine` to the allowlist.
3. Re-run the installer in **Repair** mode (see below) to restore missing
   files.

### 2. Post-install health probe fails

**Symptoms:** `post_install.log` ends with `HTTP 503` or timeout.

**Actions:**

1. Check `astroengine_api.log` for the resolved port and startup errors.
2. Run the manual probe:
   ```powershell
   & "$env:LOCALAPPDATA\AstroEngine\env\Scripts\python.exe" `
     "$env:LOCALAPPDATA\AstroEngine\installer\windows_portal_entry.py" `
     --launch api --health-only --verbose
   ```
3. If port 8000 is occupied, confirm the auto-selected alternative in
   the log and instruct the operator to access the UI via the recorded
   port.
4. For persistent failures, capture `uvicorn` stack traces from the same
   log and escalate to the API maintainers.

### 3. Virtual environment corruption

**Symptoms:** Launch shortcuts exit immediately; `astroengine_api.log`
contains `ModuleNotFoundError` for shipped dependencies.

**Actions:**

1. Run the repair shortcut (details below).
2. If repair fails with pip hash mismatches, delete
   `%LOCALAPPDATA%\AstroEngine\env` and execute the offline bundle or
   repair command again to regenerate the environment.
3. Verify `requirements.lock/py311.txt` hash lines match repository
   values before reattempting.

## Repair and recovery flows

### Start Menu repair shortcut

- **Shortcut:** `Repair AstroEngine`
- **Target:** `env\Scripts\python.exe installer\PostInstallRepair.py`
- **Workflow:** Recreate virtual environment, reinstall hashed wheels,
  rerun Alembic migrations, execute API/UI health probes.
- **Validation:** Confirm `repair-YYYYMMDD.log` ends with `status=success`
  and that the API/UI logs rotate within the last 5 minutes.

### Control Panel / Settings repair

- Launch `msiexec /fa Setup.msi` or choose **Repair** from Apps & Features.
- Monitor `%LOCALAPPDATA%\AstroEngine\logs\repair` for the new log file.
- After completion, run:

  ```powershell
  & "$env:LOCALAPPDATA\AstroEngine\env\Scripts\python.exe" `
    "$env:LOCALAPPDATA\AstroEngine\installer\windows_portal_entry.py" --launch both --timeout 120
  ```

  The command should emit `API ready on http://127.0.0.1:8xxx` followed by
  `UI launched at http://127.0.0.1:85xx`.

### Manual runtime rebuild (last resort)

1. Backup `%LOCALAPPDATA%\AstroEngine\var\dev.db` and any custom data.
2. Remove the virtual environment and cached wheels:

   ```powershell
   Remove-Item "$env:LOCALAPPDATA\AstroEngine\env" -Recurse -Force
   Remove-Item "$env:LOCALAPPDATA\AstroEngine\installer\cache" -Recurse -Force
   ```

3. Execute the offline installer with `/REPAIR` or rerun the online setup.
4. Verify Alembic migrations finish via `alembic.log` and run the health
   probe command above.

## Escalation criteria

Escalate to the installer maintainers when any of the following occur:

- `repair-*.log` records repeated hash mismatches after a fresh runtime
  rebuild.
- Installer exits with MSI code `1603` despite antivirus exclusions and
  disk space > 5 GB.
- Health probe passes, but UI fails to bind to ports 8501-8511 even after
  firewall rule confirmation.
- Diagnostic bundle contains unhandled Python stack traces during the
  `PostInstallRepair.py` step.

When escalating, attach:

1. Latest installer/repair logs (`setup-*.log`, `post_install.log`,
   `repair-*.log`).
2. Runtime logs (`astroengine_api.log`, `astroengine_ui.log`).
3. Output of the manual probe command with `--verbose` flag.
4. Screenshot of Windows Apps & Features entry showing installed version.
