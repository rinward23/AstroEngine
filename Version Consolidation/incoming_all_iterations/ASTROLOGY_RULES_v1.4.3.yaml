name: ASTROLOGY_RULES
version: 1.4.3
released: 2025-08-25
compatible_csv_schema: 1.2.0

# Summary:
# - Dual weekly rollups (max + mean)
# - Valence-split receptivity (PRI/NRI) with NET
# - Spike annotations with descriptors (noise/watch/actionable)
# - Composite/synastry resonance hooks
# - Future-proof layers (declinations, midpoints, harmonics, stations, limited asteroids)
#   -> All new layers default to *inactive* and include noise guards.

defaults:
  scale: {min: 0.0, max: 10.0}
  smoothing:
    daily_kernel_days: 0        # preserve spikes
    weekly_rollup: [max, mean]  # compute both
  normalization:
    method: clipped_minmax
    clip_percentiles: [5, 95]
  weights_version_tag: "2025-08-25B"

outputs:
  time_series_fields:
    - receptivity_overall
    - receptivity_positive
    - receptivity_negative
    - influence_positive           # pre-norm diagnostics
    - influence_negative
    - influence_overall
  rollups:
    - weekly_max:
        by: ISO_WEEK
        fields: [receptivity_overall, receptivity_positive, receptivity_negative]
        agg: max
    - weekly_mean:
        by: ISO_WEEK
        fields: [receptivity_overall, receptivity_positive, receptivity_negative]
        agg: mean

reporting:
  spike_annotations:
    enable: true
    delta_threshold: 1.0          # points on 0..10
    ratio_threshold: 1.25
    top_spike_days: 3
    noise_fast_share: 0.70
    actionable_slow_share: 0.50
    actionable_min_duration_days: 2
    classification_labels: {noise: amber, watch: blue, actionable: purple}
    include_causes: true          # list top aspects/eclipses/composite factors
    include_valence_mix: true     # PRI vs NRI at spike day(s)

scoring:
  receptivity:
    enable_valence_split: true
    scale: 0-10
    speed_weights: {veryfast: 0.10, fast: 0.35, mid: 0.60, slow: 1.00}
    aspect_weights: {conj: 1.00, opp: 0.90, sq: 0.85, tri: 0.70, sext: 0.55, quin: 0.45}
    planet_speed_class:
      Moon: veryfast
      Sun: fast
      Mercury: fast
      Venus: fast
      Mars: fast
      Jupiter: mid
      Chiron: mid
      Saturn: slow
      Uranus: slow
      Neptune: slow
      Pluto: slow
    valence_map:
      benefics: [Jupiter, Venus, Sun, Moon]
      malefics: [Saturn, Mars, Pluto, Neptune, Uranus]
      aspect_defaults: {tri: +1, sext: +1, sq: -1, opp: -1, quin: -1, conj: context}
      conj_rules:
        Jupiter: +1
        Venus: +1
        Sun: +1
        Moon: +1
        Saturn: -1
        Mars: -1
        Pluto: -1
        Neptune: -1
        Uranus: -1
        default: +1

  manifestation:
    enable_valence_split: true
    external_bias:
      angles: {Asc: 0.35, MC: 0.35, Desc: 0.35, IC: 0.30}
      houses_external: [1st, 7th, 10th, 4th]
      houses_internal: [12th, 8th, 6th]
      succedent: 0.8
      cadent: 0.6

  natal_sensitivity:
    range: [0.2, 2.0]
    weights:
      planets: {Sun: 0.05, Moon: 0.25, Mercury: 0.05, Venus: 0.05, Mars: 0.05, Jupiter: 0.05, Saturn: 0.05, Uranus: 0.15, Neptune: 0.25, Pluto: 0.15}
      angular_bonus: 0.15
      water_emphasis: 0.10
      tight_orb_bonus: {threshold_deg: 1.5, add: 0.10}

  dynamic_receptivity:
    base: 1.0
    bounds: [0.4, 1.8]
    contributions:
      sleep_debt_penalty: {per_bad_night: -0.05, cap: -0.20}
      overload_penalty: {threshold_daily_abs_sum: 4.0, per_unit_over: -0.03, cap: -0.25}
      resonance_bonus: {strong_contact: +0.10, exact_contact: +0.20}

  transit_influence:
    sign_rules: {conjunction: context_dependent, opposition: negative, square: negative, trine: positive, sextile: positive, quincunx: negative_soft}
    tables:
      planet_weight: {Sun:1.00, Moon:0.65, Mercury:0.45, Venus:0.55, Mars:0.75, Jupiter:0.80, Saturn:0.95, Uranus:1.10, Neptune:1.00, Pluto:1.15, Node:0.60, Chiron:0.40}
      aspect_weight: {conjunction:1.00, opposition:0.90, square:0.80, trine:0.75, sextile:0.55, quincunx:0.45}
      orb_factor:
        base_orbs_deg: {luminaries:6.0, inner:4.0, outer:3.0, angles:3.0}
        curve: linear_falloff
      house_factor: {angular:1.00, succedent:0.80, cadent:0.60}
      dignity_factor: {essential: 0.00, accidental: 0.00}
      speed_factor:
        daily_motion_deg_thresholds: {fast: 1.2, medium: 0.3, slow: 0.1}
        multipliers: {fast: 0.6, medium: 1.0, slow: 1.3}
      retrograde_factor: {direct:1.00, retrograde:0.90}
      target_weight: {luminaries:1.10, personal_planets:0.85, social_planets:0.70, outer_planets:0.90, angles:1.25, points:0.60}
      event_window_factor: {exact_day:1.00, "+/-1d":0.60, "+/-2d":0.35, outside:0.00}

  progression_influence:
    include: true
    weight_multiplier: 0.75
    progressed_moon_special: {orb_deg:1.2, multiplier:1.15}

  fixed_star_influence:
    include: true
    orb_deg: 1.0
    multiplier: 0.40

  eclipse_influence:
    include: true
    window_days: 45
    peak_multiplier: 1.25

  lunar_rules:
    include: true
    use_for_receptivity_modulation_only: true
    effect: {same_sign_as_natal_moon: +0.05, moon_void_of_course: -0.05}

  # --- NEW OPTIONAL LAYERS (guarded; default inactive) -----------------
  declination_influence:
    include: false                 # default off (enable if you want parallels)
    noise_guard:
      min_supporting_factors: 1    # require at least one slow-mover or angle hit
      min_orb_parallel_deg: 0.30   # only tight
    weights:
      parallel:   {multiplier: 0.60, valence: context}
      contraparallel: {multiplier: 0.55, valence: context}

  midpoint_influence:
    include: false                 # default off
    track: [Sun/Moon, Venus/Mars, ASC/MC]
    noise_guard:
      require_transit_slowmover: true
      max_midpoints: 3             # cap to avoid noise
      tight_orb_deg: 1.0
    multiplier: 0.50

  harmonic_influence:
    include: false                 # default off
    harmonics: [7, 9, 11]
    noise_guard:
      only_when_slowmover_exact: true
    multiplier: 0.35

  asteroid_influence:
    include: false                 # default off; enable upon user request
    bodies: [Juno]                 # minimal default set
    noise_guard:
      require_angle_or_personal_hit: true
      tight_orb_deg: 1.0
    multiplier: 0.30

  station_phase_influence:
    include: true                  # stations/cazimi are impactful
    retrograde_station_multiplier: 1.15
    direct_station_multiplier: 1.10
    cazimi_multiplier: 1.10
    heliacal_rising_multiplier: 1.05

channels:
  enable: true
  map:
    Identity: [Sun, Asc, MC]
    Emotion: [Moon]
    Mind: [Mercury, 3rd, 9th]
    Relating: [Venus, Desc, 7th, Vertex]
    Drive: [Mars, 1st]
    Structure: [Saturn, 10th, 6th]
    Growth: [Jupiter, 9th, 11th]
    Change: [Uranus, Pluto, 8th]
    Spirit: [Neptune, 12th]
  display_weights: {Identity:1.0, Emotion:1.0, Relating:1.0, Drive:0.9, Structure:0.9, Growth:0.9, Change:1.1, Spirit:1.0}

composites_and_synastry:
  enabled: true
  composite_rules:
    base: mean
    resonance_multiplier: {strong_composite_hit:+0.15, exact:+0.25}
  synastry_rules:
    tight_angle_contact_deg: 1.0
    multipliers: {benefic_to_personal:+0.10, malefic_to_personal:+0.10}

normalization_pipeline:
  - step: split_pos_neg
  - step: apply_dynamic_receptivity
  - step: apply_natal_sensitivity
  - step: normalize_individual_series
    method: clipped_minmax
    params: {clip_percentiles: [5, 95]}
  - step: compute_weekly_rollups
    agg: [max, mean]
  - step: compute_spike_annotations

data_contracts:
  individuals_csv:
    add_optional:
      - temperament_bias_positive
      - temperament_bias_negative
  event_log_csv:
    add_optional:
      - confidence_level            # 0..1
      - source                      # self|external|observed
      - observed_valence            # positive|negative|neutral
      - channel_id                  # Identity|Emotion|Relating|...
      - intensity_observed          # 0..10
      - notes

validation:
  unit_checks:
    - name: PRI/NRI non-negative after norm
      rule: "receptivity_positive >= 0 and receptivity_negative >= 0"
    - name: Overall bounded
      rule: "0 <= receptivity_overall <= 10"
    - name: Spike preservation
      rule: "daily_kernel_days == 0"

migration_notes:
  from_v1_4_1:
    - Added dual weekly rollups and spike annotations (no breaking changes).
    - Added optional layers (declination, midpoints, harmonics, asteroids) with strict noise guards and default include=false.
    - Stations/cazimi multipliers added (small, bounded).

changelog:
  - 1.4.3:
      - Dual rollups (max+mean); spike detector with descriptors.
      - Optional layers added with conservative defaults and noise guards.
      - Composite/synastry unchanged; minor tuning to defaults.