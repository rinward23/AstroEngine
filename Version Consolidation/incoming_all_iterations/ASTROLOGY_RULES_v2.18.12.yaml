# ======================================================================
# ASTROLOGY_RULES — Unified Ruleset (v2.18.12 Final+Report)
# Hybrid gating + capture margins + interactive prompts + post-run report
# ======================================================================

version: "2.18.12"
ruleset_name: "ASTROLOGY_RULES_v2.18.12.yaml"
generated:
  timestamp_utc: "__AUTO__"
  seed: 271828
  author: "Astrology Project — AP-SUPER"
  notes: "Adds automatic end-of-run inclusion/exclusion report with reasons."

# Inherit v2.18.11 behavior. Only new/changed sections below.

telemetry:
  # Collect everything needed for a transparent report.
  record_corridor_delta: true
  record_js_distance: true
  record_flashpoint_delta: true
  record_channel_weights: true
  record_shadow_events: true
  record_user_inclusions: true
  record_capture_margins: true
  record_symbolic_markers: true
  record_exclusion_reasons: true   # NEW: standardized reason codes
  reason_code_map:                  # NEW: human-readable mapping
    BELOW_THRESHOLD: "Below gating threshold"
    NEAR_THRESHOLD_BUFFER: "Near-threshold (buffer) — prompted"
    USER_DECLINED: "Prompted but user declined"
    OVERSHADOWED: "Overshadowed by stronger channel"
    OUTSIDE_ORB: "Outside adaptive orb"
    WITHIN_CAPTURE_MARGIN: "Included via capture margin"
    SYMBOLIC_ONLY: "Symbolic marker only (non-scoring)"
    INCLUDED_GATED: "Included (passed gating)"
    INCLUDED_USER: "Included by user confirmation"
    EXCLUDED_POLICY: "Excluded by policy (e.g., other-individuals not requested)"
    EXCLUDED_DUPLICATE: "Merged into composite flashpoint (duplicate)"

reporting:
  post_run_report:
    enabled: true
    # What to include in the report
    sections:
      - "Summary"
      - "Included (Gated)"
      - "Included (Capture-Margin)"
      - "Included (User-Confirmed)"
      - "Symbolic Markers (Non-scoring)"
      - "Excluded (Near-Threshold)"
      - "Excluded (Below Threshold)"
      - "Excluded (Policy)"
    # Sort order within sections
    sort_by: ["date", "score_desc", "orb_asc"]
    # Fields to display per item
    fields:
      - "date"
      - "channel"
      - "aspect"
      - "entities"        # e.g., Chris↔Composite, Synastry pair, etc.
      - "orb_deg"
      - "scores"          # corridorΔ / JS / flashpointΔ / weight
      - "reason_code"
      - "reason_text"
    # Output options
    output_formats:
      - "inline_table"
      - "csv_inline"
    csv_filename_pattern: "post_run_report_{start}_{end}_v{version}.csv"
    # Footnote in the report
    footnote: >
      Reason codes reflect gating + capture-margin logic. Symbolic markers are logged even
      when non-scoring. User-included events are annotated and rescored for this run.
      Ruleset v{version}, seed {seed}.

io_contract:
  outputs:
    default: ["text_interpretation", "post_run_report"]   # NEW: include report by default
    optional_on_request: ["graph_inline","csv_inline","graph_download","csv_download"]
    interactive_prompts: ["near_threshold_candidates"]
  behavior:
    prompt_for_graphs_at_end: true
    if_graphs_requested_display_inline_only: true
    offer_download_link_only_if_user_confirms: true

# End of file — v2.18.12
