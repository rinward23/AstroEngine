# ==========================================
# ASTROLOGY PROJECT — EMBEDDED INSTRUCTION SET (v1.2)
# ==========================================

version: 1.2
modes:
  default: AP-SUPER
  available: [AP-SUPER, AP-LITE, AP-STRICT, AP-DEBUG]

defaults:
  house_system: whole
  timezone: ET                 # America/New_York
  reloc: false
  sidereal: false
  stars: precess
  solar_fire: on               # use ephemeris exacts when present
  tob_margin: "±0:45"          # widen time-sensitive calls if TOB fuzzy

entities_included:
  angles: true                 # ASC/DSC, MC/IC
  luminaries: true             # Sun, Moon
  nodes: true
  vertex: true
  part_of_fortune: true

layers:
  include: [Natal_Chris, Natal_Remy, Composite, Davison, Progressions, SolarArc, Tertiary,
            Harmonic7, Harmonic9, Harmonic11, Eclipses_Saros, FixedStars, Draconic, SymbolLog]
  note: "Tag each datum by layer before synthesis; use Solar Fire/ephemeris as source of truth when available."

files_to_consult:
  preferred: ["Transit Data (year)", "Progressed Planets - Aspects", "Transit Planets - Aspects to Natal Planets",
              "Chris - Natal Chart Data", "Remy - Natal Chart Data", "Composite Data - All - Remy and Chris"]

# ---- DEGREE ORBS (for aspects) ----
orbs:
  majors: { conj: 6, opp: 6, square: 5, trine: 5, sextile: 4, quincunx: 2 }
  angle_lum_bonus: +1
  progressions: { majors: 1, minors: 0.5 }
  solar_arc:   { majors: 1, minors: 0.5 }
  tertiary: 0.5
  transits: { majors: 5, minors: 2, outer_angle_bonus: +1 }
  declination: { lum: 0.5, planets: 0.33 }
  fixed_stars: { normal: 0.33, royal: 0.67 }

# ---- TIMING WINDOWS (DAYS) for text orbs/probability windows ----
timing_windows_days:
  slow_movers: 10              # Saturn/Uranus/Neptune/Pluto background
  jupiter: 6
  inner_planets: { min: 3, max: 4 }   # Sun/Venus/Mercury
  moon:
    use_in_scoring: false
    micro_trigger_hours: 24

event_precision_rules:
  day_specific_for: [Sun, Venus, Mercury, Angles]
  not_day_specific_for: [Jupiter, Saturn, Uranus, Neptune, Pluto]
  note: "Always state precision explicitly for each item."

probability_labels:
  Low: "<50"
  Watch: "50-59"
  Active: "60-74"
  Strong: ">=75"

# ---- INTERNAL vs EXTERNAL CONSTRUCTION (explicit weights) ----
internal_external_weights:
  planets_internal_bias:       # positive => increases Internal; negative => decreases Internal (thus External)
    Saturn: +0.9
    Pluto: +0.8
    Node: +0.6
    Neptune: +0.2
    Jupiter: -0.5
    Sun: -0.5
    Venus: -0.4
    Uranus: -0.6
    Mars: -0.3
    Mercury: -0.2
  houses_internal_bias:        # applied when transits hit these houses/angles
    H12: +0.6
    H8:  +0.5
    H4:  +0.3
    ASC: -0.3
    MC:  -0.4
    H1:  -0.2
    H7:  -0.2
    H10: -0.3
  aspect_modifiers:            # extra shove toward External for hard aspects
    hard: +0.10                # conj/square/opposition => +10 points to External (i.e., -10 to Internal)
    easy: -0.05                # trine/sextile => +5 points to Internal (i.e., less externalization)
  scaling:
    minmax_to_0_100: true
    base_offsets: { shared: 40, chris: 45, remy: 35 }
    clamp: [0, 100]

# ---- SCORING & PRESSURE/RELIEF ----
scoring:
  layers_weight:
    Natal: 0.8
    Composite: 1.0
    Davison: 1.0
    ProgComp: 1.0
    SolarArc: 0.8
    Transit: 0.8
    Tertiary: 0.6
    Harmonics: 0.6
    FixedStars: 0.5
    EclipseNode: 1.0
  per_hit_weights:
    orb_tightness: 0.35
    point_weight: 0.20
    layer_weight: 0.15
    applying_bonus: 0.05
    angular_bonus: 0.10
    timestamp_conf: 0.10
    recurrence_echo: 0.05
  tiers: { very_high: 80, high: 60, moderate: 40 }

pressure_relief:
  pressure:
    Pluto: +5
    Saturn: +4
    Node: +4
    Eclipse: +4
    Mars_hard: +3
    ProgMoon_sq_Pluto: +3
    Uranus_hard: +3
    Neptune_hard: +2
  relief:
    Jupiter_easy: -3
    Venus_easy: -2
    Saturn_easy: -1
    Mercury_easy: -1
  modifiers:
    dignified_benefic: 1.2
    detriment_benefic: 0.8
    angular: 1.1
    cadent: 0.9
  caps: { per_day: 20 }
  release: { benefic_stack: 60, duration_hours: 24 }

# ---- SPECIAL CASES (clarity) ----
special_cases:
  stations:
    extend_window_days: 2      # add ±2 days
    amplitude_boost: 0.15      # +15% to kernel amplitude
    note: "If station belongs to Uranus/Mars => External bias; Saturn/Pluto => Internal bias."
  eclipses:
    extend_window_days: 5
    external_probability: "raise one tier"   # e.g., Active→Strong if other signals support it
  retrogrades:
    mercury_retro:
      external_effects: "communication, travel, tech visible"
      internal_bias: +0.10     # nudge toward Internal due to review/rethink
  unknown_TOB_policy:
    deweight_houses_pct: 50    # cut house/angle weighting by 50%
    widen_corridors: { Shared: +1, Chris: +1, Remy: +1, Prob: +1 }
    widen_windows_days: +1

# ---- KERNEL MODEL (how intensities are built) ----
kernels:
  base_intensity: 40
  sigma_days:
    slow_movers: [7, 10]
    jupiter: [5, 7]
    inner_planets: [2, 4]
  amplitude_hint:
    slow_movers: "lower (background theme)"
    jupiter: "medium"
    inner_planets: "higher (flashpoints)"
  channels: [SharedStack, SoloChris, SoloRemy]
  clamp_range: [0, 100]
  smoothing:
    apply: false                # set true to enable
    method: "ema"
    span_days: 3

# ---- CONVERGENCE/DIVERGENCE ----
convergence:
  distance: "abs(SoloChris - SoloRemy)"
  conv_probability: "100 - normalized(distance)"
  div_probability: "100 - conv_probability"
  conv_div_score: "- delta(distance)"
  indecision_zone_tolerance_percent: 10

# ---- CHARTING / VISUALIZATION ----
charting:
  charts: [Intensity, Internal_vs_External, Convergence_Divergence]
  one_pdf_per_window: true
  corridors: { Shared: 7, Chris: 6, Remy: 8, Prob: 6 }   # ± bands
  overlaps:
    apply_to: [Intensity, Internal, External]
    colors:
      Shared∩Chris: "#1f77b4"   # blue
      Shared∩Remy:  "#d62728"   # red
      Chris∩Remy:   "#ffbf00"   # gold
      AllThree:     "#7f7f7f"   # gray
    alpha: 0.18
  tiers:
    thresholds: { Strong: 75, Active: [60,74], Watch: [50,59] }
    apply_to: [internal_avg, external_avg, conv_prob, div_prob]
    colors:
      internal: { Strong: "#b39ddb", Active: "#d1c4e9", Watch: "#ede7f6" }
      external: { Strong: "tab:orange", Active: "#ffcc80", Watch: "#ffe0b2" }
      converge: { Strong: "#66bb6a", Active: "#a5d6a7", Watch: "#c8e6c9" }
      diverge:  { Strong: "#ef5350", Active: "#ef9a9a", Watch: "#ffcdd2" }
    alpha:
      Strong: 0.22
      Active: 0.16
      Watch:  0.12
  mixed_windows:
    detect: "zero-cross of (internal_avg - external_avg)"
    diff_tolerance_points: 10
    shared_intensity_percentile: 90
    remove_if_contained_in_other_tier: true
    color: "olive"
    alpha: 0.18
  window_precedence:            # if two window types overlap on the same chart
    order: [Mixed, External, Internal, Converge, Diverge]
    label_mode: "single_highest_precedence"
  labels:
    format: "<Type> <#>: MMM DD–MMM DD"
    date_zone: "local_midnight_ET"
  xaxis:
    major_ticks: weekly_monday
    minor_ticks: daily
    month_lines: dashed

output_naming:
  pdf: "<Window>_three-charts.pdf"
  pngs: [ "<Window>_intensity.png", "<Window>_internal-external.png", "<Window>_convergence-divergence.png" ]

# ---- TEXT OUTPUT / INTERPRETATION ----
text_output_order:
  - Summary
  - Data snapshot (by layer)
  - Interpretation (per layer → synthesis)
  - Watchlist (micro-windows)
  - Assumptions & gaps

interpretation_block_order:
  - Snapshot                       # list hits w/ orb, energy type, precision, external prob
  - Per-Chart Context              # explain Intensity, Internal/External, Convergence signals
  - Overall Trend
  - Practical Implication
  - Projection Safeguard
  - Watchlist
  - Visualization Prompt

snapshot_rules:
  include: [orb, energy_type, precision, external_probability, projection_safeguard]
prompt_text: "Would you like to see the visualization for this window?"

assumptions:
  corridor_ranges: { Shared: "5-9", Chris: "4-8", Remy: "6-10", Prob: "4-8" }
  tier_cutoffs_adjustable: [55, 70, 85]
  moon_policy: "Use as micro-timer only (no scoring)."
  dst_boundary:
    timezone: "America/New_York"
    day_boundary: "00:00 local"   # always compute window start/end by local midnight ET, DST-aware

quality_checks:
  - "Every transit/window lists: orb, energy type, precision, external probability"
  - "All window boxes have start–end labels"
  - "Overlap colors match legend and precedence"
  - "Indecision zone shaded where |conv - div| ≤ tolerance"
  - "Text follows both output orders (section + interpretation block)"
  - "End with visualization prompt"
