# VCA Protocol — Version 2.2
# Source of Truth for Astrology - Final (AP Super default semantics)
# Notes:
# - This file supersedes v2.1 and integrates performance, optimization, cleanup, and safety suggestions.
# - Treat all runs as AP Super under-the-hood; profiles adjust gating/orb/QDF only.
# - Manifest and checksum pins required for deterministic ingestion.

vca:
  version: "2.2"
  build:
    date: "2025-09-02"
    commit: "v2.2-initial-rollup"
  doctrine:
    immutable_core: true
    violation_policy:
      flag_and_prompt: true
      prompt_text: >
        The requested action conflicts with a protected doctrine rule: {{rule}}.
        Consequences: {{consequence}}. Override anyway?
      allow_override: true

  cache:
    total_size_cap_mib: 2048        # hard cap for all runs on disk
    tiers:
      small: { days_span_max: 3,   keep_last: 6,  size_cap_mib: 256 }
      medium:{ days_span_max: 31,  keep_last: 4,  size_cap_mib: 768 }
      large: { days_span_max: 366, keep_last: 2,  size_cap_mib: 1024 }
    retention_basis: "date_range"   # replaces profile-based retention
    eviction:
      order: [unpinned_oldest, pinned_oldest]  # pinned may be evicted last if caps hit
    nightly_maintenance:
      enabled: true
      tasks: [compact_indexes, prune_stale_artifacts, verify_checksums]
      window_local: "02:00-04:00"
      safety_floor_keep_last_runs: 2

  run_meta:
    seed: "auto"   # "auto" = uuid per run; set numeric to freeze sorting decisions
    logging:
      level: "info"
      include:
        - run_header
        - active_modules
        - thresholds_applied
        - gating_decisions
        - degradations
        - import_checksums
    determinism:
      time_zone: "America/New_York"
      float_precision: 1e-9

  qdf:  # recency gates (Query Deserves Freshness)
    stable: { lookback_days: 3650, weight: 1.0 }   # 10 years
    recent: { lookback_days: 540,  weight: 1.1 }   # ~18 months
    hot:    { lookback_days: 60,   weight: 1.2 }   # ~2 months

  orb_modifiers:  # centralized arc tolerances (applied multiplicatively to base orbs)
    strict:    { factor: 0.85, min_arcmin: 10 }
    super:     { factor: 1.00, min_arcmin: 12 }
    narrative: { factor: 1.10, min_arcmin: 14 }
    daily:     { factor: 1.05, min_arcmin: 13 }

  thresholds:
    aspect_strength_floor: 0.15
    composite_union_strategy: "weighted_union"
    include_when_present: [harmonics, draconic, davison, vertex, midpoints]

  profiles:
    ap_super:
      description: "Default computational semantics; wide module coverage."
      include_modules: [core, transits, aspects, composites, importers, jungian_overlay]
      orb_modifier: "@orb_modifiers.super"
      qdf_gate: "@qdf.recent"
      jungian_overlay_eval: "lazy"
    daily:
      inherits: ap_super
      profile_flag: daily
      include_modules: [core, transits, aspects, jungian_overlay]
      include_when_present: "@thresholds.include_when_present"
      orb_modifier: "@orb_modifiers.daily"
      qdf_gate: "@qdf.hot"
      jungian_overlay_eval: "eager"
    monthly:
      inherits: ap_super
      include_modules: [core, transits, aspects, jungian_overlay, composites]
      include_when_present: "@thresholds.include_when_present"
      orb_modifier: "@orb_modifiers.narrative"
      qdf_gate: "@qdf.recent"
      jungian_overlay_eval: "eager"
    strict:
      inherits: ap_super
      orb_modifier: "@orb_modifiers.strict"
      qdf_gate: "@qdf.stable"
      jungian_overlay_eval: "lazy"

  ingest:
    manifest_version_required: ">=1.6"
    checksum_policy: "strict"
    sources:
      solar_fire:
        allow_lossy: false
        mapping: "@schemas.solar_fire_v1"
      astro_seek:
        allow_lossy: false
        mapping: "@schemas.astro_seek_v1"
      csv_generic:
        allow_lossy: false
        mapping: "@schemas.generic_csv_v1"
    fallback_freeform:
      enabled: true
      strategy: "tag_based_dynamic_schema"  # creates schema on the fly from tags/headers
      lossless: true

  jungian_overlay:
    components: [shadow, anima_animus, self, persona, complex_map]
    caching: true
    mode_defaults:
      daily:    { evaluation: "eager" }
      monthly:  { evaluation: "eager" }
      ap_super: { evaluation: "lazy" }
      strict:   { evaluation: "lazy" }
    weights:
      shadow: 1.00
      anima_animus: 0.95
      self: 1.05
      persona: 0.90
      complex_map: 1.10

  composites:
    enabled: true
    variants:
      midpoint:             { weight: 1.00, include_midpoints: true }
      davison_relationship: { weight: 0.95 }
      coalescent:           { weight: 0.90 }
      group_drv_asc:        { weight: 0.85 }
      drv_asc:              { weight: 0.80 }
    conflict_resolution:
      strategy: "weighted_union"
      tie_break:
        prefer_variants: [midpoint, davison_relationship, coalescent]
        seeded: true

  resilience:
    module_failure:
      action: "degrade_and_continue"
      report: true
    timeouts:
      module_ms: 120000
      importer_ms: 180000

  gating:
    # central gate combining orb, QDF, and aspect strength
    formula: >
      gate_score = aspect_strength * qdf_weight * orb_factor;
      include if gate_score >= 0.12

  modules:
    core:
      enabled: true
      tasks: [chart_load, normalize, index]
    importers:
      enabled: true
      tasks: [manifest_check, checksum_verify, source_map, parse, normalize]
    transits:
      enabled: true
      options:
        ephemeris_source: "MASTER_Ephemeris_0000-3000_merged.sqlite"
        lookahead_days: 370
    aspects:
      enabled: true
      base_orbs_arcmin:
        conjunction: 480
        opposition: 420
        trine: 360
        square: 360
        sextile: 300
        quincunx: 240
        semisquare: 150
        sesquiquadrate: 150
    harmonics:
      enabled: true
      numbers: [1,2,3,4,5,6,7,8,9,10,11,12]
      file: "Chris_Remy_Harmonics_1-12_with_numbers.csv"
    draconic:
      enabled: true
      file: "Chris_Remy_Draconic_Natal_Structured.csv"
    composites_module:
      enabled: true
      files:
        - "Chris_&_Remy_-_Composite_ALL_MERGED.csv"
        - "CV_CR_Composite_Midpoints.csv"
    jungian_overlay_module:
      enabled: true
      depends_on: [aspects, transits]
    vertex:
      enabled: true
    midpoints:
      enabled: true

  io:
    inputs:
      - "Chris_ALL_MODULES_MERGED.csv"
      - "Remy_ALL_MODULES_MERGED.csv"
      - "Chris_&_Remy_-_Composite_ALL_MERGED.csv"
      - "CV_Natal_Chart.csv"
      - "MASTER_Ephemeris_0000-3000_merged.csv"
      - "MASTER_Ephemeris_0000-3000_merged.sqlite"
      - "ASTRO_ENGINE_FINAL.sqlite"
      - "ENTITIES_20250902_142650Z.csv"
      - "CHARTS_20250902_142650Z.csv"
      - "EVENTS_20250902_142650Z.csv"
    outputs:
      logs_dir: "logs/v2.2"
      cache_dir: "cache/v2.2"
      reports_dir: "reports/v2.2"

  validation:
    schema: "VCA_Protocol_v2_schema.json"
    rules:
      - check: "pointers_resolve"
      - check: "file_presence"
      - check: "no_duplicate_module_ids"
      - check: "profiles_inherit_resolve"

  changelog:
    v2_2:
      - "Consolidated orb modifiers into central table; removed scattered overrides."
      - "Introduced QDF gates (stable/recent/hot) and wired per-profile."
      - "Nightly maintenance with compact/prune/verify; safety floor of 2 runs."
      - "Date-range–based cache tiering; pinned eviction as last resort."
      - "Mandatory manifest/version pin + checksum policy=strict."
      - "Jungian overlay eager in daily/monthly; lazy in ap_super/strict."
      - "Composite variants unified under weighted union with tie-break."
      - "Resilience: degrade-and-continue on module failures; structured logs."
      - "Profiles normalized to AP Super semantics; daily/monthly widen orbs."
      - "Importer fallback for freeform/tag-based inputs (lossless)."

# EOF
