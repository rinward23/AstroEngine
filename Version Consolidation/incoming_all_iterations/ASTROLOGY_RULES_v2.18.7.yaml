# ASTROLOGY_RULES_v2.18.7.yaml
# AP-SUPER profile — unified master rules
# -----------------------------------------------------------------------------
# CHANGE LOG (v2.18.7)
# • Per-channel auto-gating overrides added (harmonics, draconic, synastry, composite,
#   composite_multi, network_synastry, declination_midpoints, event_log).
# • Event Log flash-lift guarded with base-min policy to avoid 0→N artifacts.
# • Dynamic scope: auto-gate ALL disabled AP-SUPER channels (except USA/mundane).
# • Testing mode retained: consent prompts disabled; include other individuals only when named.
# • Provenance logs expanded to include per-channel thresholds and decision rules used.
#
# Defaults inherit from v2.18.6 unless explicitly modified below.

meta:
  version: 2.18.7
  updated_utc: 2025-08-29T00:00:00Z
  profile: AP-SUPER
  testing_mode: true
  apcfg: "[APCFG rules=YAML v2.18.7] house=whole node=true tz=America/New_York reloc=no sidereal=no stars=precess sf=on tob=est±0:45"

# --- POLICIES -----------------------------------------------------------------
execution_policy:
  include_individuals_only_when_requested: true   # include other people only if the user names them
  include_mundane_usa: false                      # USA/mundane remains opt-in only
  consent_policy:
    mode: disabled_for_testing                    # no consent prompts during testing

synthetic_data_safeguard:
  default: "disallow_without_consent"
  when_real_data_unavailable:
    notify_user: true
    explain_meaning_loss: true
    ask_to_proceed: true
    watermark_outputs: true
  labels:
    watermark_text: "SYNTHETIC PREVIEW — Not ruleset-driven"
  file_naming:
    suffix: "_SYNTHETIC"
  logging:
    record_reason: true
    record_user_choice: true

# --- AUTO-GATING --------------------------------------------------------------
auto_gating:
  enabled: true
  enable_for_heavy_channels: true
  decision_rule: two_of_three
  metrics:                            # GLOBAL defaults (fallback thresholds)
    corridor_power_delta_min: 0.12
    js_distance_min: 0.08
    flashpoint_lift_min: 0.10
  scope:
    mode: all_disabled_in_channels
    exclude: [mundane_usa]
  overrides:                          # Channel-specific overrides
    harmonics_h1_h12:
      metrics:
        corridor_power_delta_min: 0.10
        js_distance_min: 0.09
        flashpoint_lift_min: 0.10
    draconic_overlays:
      metrics:
        corridor_power_delta_min: 0.10
        js_distance_min: 0.10
        flashpoint_lift_min: 0.10
    synastry:
      metrics:
        corridor_power_delta_min: 0.14
        js_distance_min: 0.10
        flashpoint_lift_min: 0.12
    composite:
      metrics:
        corridor_power_delta_min: 0.15
        js_distance_min: 0.10
        flashpoint_lift_min: 0.12
    composite_multi:
      decision_rule: three_of_three
      metrics:
        corridor_power_delta_min: 0.16
        js_distance_min: 0.12
        flashpoint_lift_min: 0.12
    network_synastry:
      decision_rule: three_of_three
      metrics:
        corridor_power_delta_min: 0.17
        js_distance_min: 0.12
        flashpoint_lift_min: 0.15
    declination_midpoints:
      metrics:
        corridor_power_delta_min: 0.12
        js_distance_min: 0.11
        flashpoint_lift_min: 0.10
    event_log:
      decision_rule: two_of_three
      metrics:
        corridor_power_delta_min: 0.12
        js_distance_min: 0.10
        flashpoint_lift_min: 0.20
      flash_metric_policy:
        require_base_flashpoints_min: 1
  gating_notes:
    - "If base flashpoints == 0, flashpoint_lift can inflate; event_log guard applies; others must annotate rationale."
    - "Auto-enabled channels must be recorded in summary_json.gating_decisions and chart footnote."
    - "Heavy channels are compute-intensive; record runtime in provenance."

interpretation_policy:
  on_auto_enabled:
    include_symbolic_context: true
    templates:
      harmonics: |
        Harmonics add fine-grained patterning and modulation. Higher H → specialization/focus; lower H → fundamentals/form.
      draconic: |
        Draconic overlays highlight purpose/roots themes (node-referenced). Events can feel ‘fated’ or long-arc in tone.
      synastry: |
        Synastry emphasizes inter-chart triggers and resonance patterns; timing windows heighten interpersonal dynamics.
      composite: |
        Composite emphasizes the relationship entity’s weather; peaks mark joint visibility/pressure points.
      declination_midpoints: |
        Declination parallels/contraparallels add intensity bands and off-ecliptic triggers.
      event_log: |
        Event-aligned spikes validate timing sensitivity and support hypothesis checks during active windows.
    placement_in_outputs:
      - summary_json.symbolic_context
      - narrative_overview.section: "Context & Interpretation"

# --- PRE-RUN CHECKLIST --------------------------------------------------------
pre_run_checklist:
  - id: individuals_named_if_included
    description: "If other individuals are to be included, their names must be present in the user request."
    on_fail: HALT_AND_PROMPT
  - id: mundane_disabled_by_default
    require_false: execution_policy.include_mundane_usa
    on_fail: FORCE_FALSE_AND_NOTE
  - id: ephemeris_available
    test: qa_validation.checks.ephemeris_slice_available
    on_fail: HALT_AND_PROMPT
  - id: natal_loaded
    test: qa_validation.checks.natal_data_loaded
    on_fail: HALT_AND_PROMPT
  - id: synthetic_policy_bound
    test: synthetic_data_safeguard.default == "disallow_without_consent"
    on_fail: HALT_AND_FIX
  - id: plotting_policy_wired
    test: visualization_policy.require_metadata_flags
    on_fail: HALT_AND_FIX
  - id: auto_gating_wired
    test: auto_gating.enabled == true
    on_fail: HALT_AND_FIX

# --- CHANNELS -----------------------------------------------------------------
channels:
  enabled_by_default:
    self: true
    external: true
    eclipse_lunation: true
  # Everything else starts disabled and can auto-enable via auto_gating.scope
  optional_layers:
    harmonics_h1_h12: false
    draconic_overlays: false
  heavy_channels:
    synastry: false
    composite: false
    network_synastry: false
    composite_multi: false
    declination_midpoints: false
    event_log: false
  preflight_auto_enable:
    thresholds: {corridor_power_delta: 0.12, js_distance: 0.08, flashpoint_lift: 0.10}

# --- CORE ENGINE --------------------------------------------------------------
aspects:
  set: [conjunction, opposition, square, trine, sextile, quincunx, semisquare, sesquisquare]
  orb_defaults_deg:
    luminaries: 8.0
    inner_planets: 6.0
    outer_planets: 5.0
    angles_points: 3.5
  orb_overrides:
    vertex: {conjunction: 2.0, opposition: 2.0}
    eclipse_lunation: {conjunction: 9.0, opposition: 9.0}
  decay_shape: gaussian
  decay_params: {gaussian_sigma_fraction_of_orb: 0.35}

valence_map:
  positive: [trine, sextile]
  negative: [square, opposition, semisquare, sesquisquare]
  neutral: [conjunction, quincunx]

weights:
  channel:
    self: 1.00
    external: 0.85
    synastry: 0.95
    composite: 1.10
    eclipse_lunation: 0.90
    harmonics: 0.30
    draconic: 0.40
  harmonics:
    H1: 1.00
    H2: 0.70
    H3: 0.65
    H4: 0.60
    H5: 0.55
    H6: 0.50
    H7: 0.75
    H8: 0.55
    H9: 0.80
    H10: 0.50
    H11: 0.45
    H12: 0.60
  planets_points:
    Pluto: 1.30
    Saturn: 1.10
    Uranus: 1.15
    Neptune: 0.95
    Jupiter: 0.90
    Mars: 1.00
    Venus: 0.85
    Mercury: 0.85
    Sun: 1.05
    Moon: 0.90
    Vertex: 1.20
    Nodes: 1.10

windows:
  polling: hourly
  merge_same_sign: {max_gap_hours: 6, method: weighted_mean}
  composite_windowing: {method: intersection_then_union}

normalization:
  method: minmax
  minmax_target: [-1.0, 1.0]
  zscore: {enabled: false, recenter_mean_to_zero: false}
  footnote_mean_offset: true

smoothing:
  stage1_window_hours: 6
  stage2_window_hours: 3

bands:
  labels:
    pos_high: "High Positive Intensity"
    pos_med: "Medium Positive Intensity"
    pos_low: "Low Positive Intensity"
    neg_low: "Low Negative Intensity"
    neg_med: "Medium Negative Intensity"
    neg_high: "High Negative Intensity"
  thresholds:
    pos_low_min: 0.10
    pos_med_min: 0.35
    pos_high_min: 0.70
    neg_low_max: -0.10
    neg_med_max: -0.35
    neg_high_max: -0.70

flashpoints:
  peak_detection: {prominence_min: 0.28, min_separation_hours: 18, neighborhood_hours: 12}
  labeling: {include_valence: true, include_channels: true, include_harmonics_when_active: true}

plotting:
  style: vizbands
  annotate_bands: true
  annotate_peaks: smart
  show_legend_groups: {harmonics_collapsed: true}
  footnote:
    show: true
    include:
      - test_types
      - calc_summary
      - orbs_and_thresholds
      - normalization_method
      - mean_offset_note
      - dataset_counts
      - channels_enabled
      - gating_decisions
      - channel_thresholds   # NEW: show per-channel thresholds used

visualization_policy:
  require_metadata_flags: true
  if_synthetic:
    watermark: "SYNTHETIC PREVIEW — Not ruleset-driven"
    filename_suffix: "_SYNTHETIC"
    footnote_append: "Synthetic preview; values illustrative only (no ephemeris/aspect engine). Accuracy loss: high for timing & magnitudes."
    palette_adjustment: dim
  if_raw:
    watermark: null
    filename_suffix: ""

qa_validation:
  checks:
    - {name: ephemeris_slice_available, action_on_fail: halt}
    - {name: natal_data_loaded, action_on_fail: halt}
    - {name: weights_sum_reasonable, bounds: [0.5, 5.0], action_on_fail: warn_and_continue}
    - {name: band_thresholds_consistent, action_on_fail: fix_and_note}
  provenance_logging:
    enabled: true
    include:
      - file_hashes
      - rules_version
      - start_end_timestamps
      - enabled_channels
      - normalization_and_smoothing
      - gating_decisions
      - gating_thresholds_by_channel   # NEW: dump the resolved metrics per channel
      - decision_rules_by_channel      # NEW: dump the resolved decision rules per channel

compliance_tests:
  - name: synthetic_must_be_watermarked
    fails_when: synthetic_run==true AND chart_watermark_missing
  - name: raw_must_not_be_watermarked
    fails_when: synthetic_run==false AND chart_watermark_present
  - name: suffix_alignment
    fails_when: (synthetic_run==true AND NOT filename_endswith("_SYNTHETIC")) OR (synthetic_run==false AND filename_endswith("_SYNTHETIC"))
  - name: footnote_contains_required_fields
    fails_when: missing_fields_in_footnote

outputs:
  corridor_csv: true
  flashpoints_csv: true
  summary_json: true
  image_png: true
  file_names:
    corridor_csv: "corridor_{who}_{YYYYMM}.csv"
    flashpoints_csv: "flashpoints_{who}_{YYYYMM}.csv"
    summary_json: "summary_{who}_{YYYYMM}.json"
    image_png: "corridor_{who}_{YYYYMM}.png"

modules:
  eclipse_lunation: {enable: true, include_solar: true, include_lunar: true, weight: 0.90, orb_override_deg: 9.0}
  vertex: {enable: true, acute_orb_deg: 2.0, decay_shape: gaussian}
  draconic: {enable: false, reference: north_node, weight_multiplier: 0.40}
  harmonics: {enable: false, include: [H1, H2, H3, H4, H5, H6, H7, H8, H9, H10, H11, H12], base_weight: 0.30}
