# ASTROLOGY_RULES_v2.18.6.yaml
# See canvas for full annotated comments; this file matches the canvas content exactly.

meta:
  version: 2.18.6
  updated_utc: 2025-08-29T00:00:00Z
  profile: AP-SUPER
  testing_mode: true
  apcfg: "[APCFG rules=YAML v2.18.6] house=whole node=true tz=America/New_York reloc=no sidereal=no stars=precess sf=on tob=est±0:45"

execution_policy:
  include_individuals_only_when_requested: true
  include_mundane_usa: false
  consent_policy:
    mode: disabled_for_testing

synthetic_data_safeguard:
  default: "disallow_without_consent"
  when_real_data_unavailable:
    notify_user: true
    explain_meaning_loss: true
    ask_to_proceed: true
    watermark_outputs: true
  labels:
    watermark_text: "SYNTHETIC PREVIEW — Not ruleset‑driven"
  file_naming:
    suffix: "_SYNTHETIC"
  logging:
    record_reason: true
    record_user_choice: true

auto_gating:
  enabled: true
  enable_for_heavy_channels: true
  decision_rule: two_of_three
  metrics: {corridor_power_delta_min: 0.12, js_distance_min: 0.08, flashpoint_lift_min: 0.10}
  scope: {mode: all_disabled_in_channels, exclude: [mundane_usa]}

interpretation_policy:
  on_auto_enabled:
    include_symbolic_context: true

pre_run_checklist:
  - {id: individuals_named_if_included, on_fail: HALT_AND_PROMPT}
  - {id: mundane_disabled_by_default, require_false: execution_policy.include_mundane_usa, on_fail: FORCE_FALSE_AND_NOTE}
  - {id: ephemeris_available, test: qa_validation.checks.ephemeris_slice_available, on_fail: HALT_AND_PROMPT}
  - {id: natal_loaded, test: qa_validation.checks.natal_data_loaded, on_fail: HALT_AND_PROMPT}
  - {id: synthetic_policy_bound, test: synthetic_data_safeguard.default == "disallow_without_consent", on_fail: HALT_AND_FIX}
  - {id: plotting_policy_wired, test: visualization_policy.require_metadata_flags, on_fail: HALT_AND_FIX}
  - {id: auto_gating_wired, test: auto_gating.enabled == true, on_fail: HALT_AND_FIX}

channels:
  enabled_by_default: {self: true, external: true, eclipse_lunation: true}
  optional_layers: {harmonics_h1_h12: false, draconic_overlays: false}
  heavy_channels: {synastry: false, composite: false, network_synastry: false, composite_multi: false, declination_midpoints: false, event_log: false}
  preflight_auto_enable: {thresholds: {corridor_power_delta: 0.12, js_distance: 0.08, flashpoint_lift: 0.10}}

aspects:
  set: [conjunction, opposition, square, trine, sextile, quincunx, semisquare, sesquisquare]
  orb_defaults_deg: {luminaries: 8.0, inner_planets: 6.0, outer_planets: 5.0, angles_points: 3.5}
  orb_overrides: {vertex: {conjunction: 2.0, opposition: 2.0}, eclipse_lunation: {conjunction: 9.0, opposition: 9.0}}
  decay_shape: gaussian
  decay_params: {gaussian_sigma_fraction_of_orb: 0.35}

valence_map: {positive: [trine, sextile], negative: [square, opposition, semisquare, sesquisquare], neutral: [conjunction, quincunx]}

weights:
  channel: {self: 1.00, external: 0.85, synastry: 0.95, composite: 1.10, eclipse_lunation: 0.90, harmonics: 0.30, draconic: 0.40}
  harmonics: {H1:1.00,H2:0.70,H3:0.65,H4:0.60,H5:0.55,H6:0.50,H7:0.75,H8:0.55,H9:0.80,H10:0.50,H11:0.45,H12:0.60}
  planets_points: {Pluto:1.30, Saturn:1.10, Uranus:1.15, Neptune:0.95, Jupiter:0.90, Mars:1.00, Venus:0.85, Mercury:0.85, Sun:1.05, Moon:0.90, Vertex:1.20, Nodes:1.10}

windows: {polling: hourly, merge_same_sign: {max_gap_hours: 6, method: weighted_mean}, composite_windowing: {method: intersection_then_union}}

normalization: {method: minmax, minmax_target: [-1.0, 1.0], zscore: {enabled: false, recenter_mean_to_zero: false}, footnote_mean_offset: true}

smoothing: {stage1_window_hours: 6, stage2_window_hours: 3}

bands:
  labels: {pos_high: "High Positive Intensity", pos_med: "Medium Positive Intensity", pos_low: "Low Positive Intensity", neg_low: "Low Negative Intensity", neg_med: "Medium Negative Intensity", neg_high: "High Negative Intensity"}
  thresholds: {pos_low_min: 0.10, pos_med_min: 0.35, pos_high_min: 0.70, neg_low_max: -0.10, neg_med_max: -0.35, neg_high_max: -0.70}

flashpoints: {peak_detection: {prominence_min: 0.28, min_separation_hours: 18, neighborhood_hours: 12}, labeling: {include_valence: true, include_channels: true, include_harmonics_when_active: true}}

plotting:
  style: vizbands
  annotate_bands: true
  annotate_peaks: smart
  show_legend_groups: {harmonics_collapsed: true}
  footnote: {show: true, include: [test_types, calc_summary, orbs_and_thresholds, normalization_method, mean_offset_note, dataset_counts, channels_enabled, gating_decisions]}

visualization_policy:
  require_metadata_flags: true
  if_synthetic: {watermark: "SYNTHETIC PREVIEW — Not ruleset‑driven", filename_suffix: "_SYNTHETIC", footnote_append: "Synthetic preview; values illustrative only (no ephemeris/aspect engine). Accuracy loss: high for timing & magnitudes.", palette_adjustment: dim}
  if_raw: {watermark: null, filename_suffix: ""}

qa_validation:
  checks:
    - {name: ephemeris_slice_available, action_on_fail: halt}
    - {name: natal_data_loaded, action_on_fail: halt}
    - {name: weights_sum_reasonable, bounds: [0.5, 5.0], action_on_fail: warn_and_continue}
    - {name: band_thresholds_consistent, action_on_fail: fix_and_note}
  provenance_logging: {enabled: true, include: [file_hashes, rules_version, start_end_timestamps, enabled_channels, normalization_and_smoothing, gating_decisions]}

outputs:
  corridor_csv: true
  flashpoints_csv: true
  summary_json: true
  image_png: true
  file_names: {corridor_csv: "corridor_{who}_{YYYYMM}.csv", flashpoints_csv: "flashpoints_{who}_{YYYYMM}.csv", summary_json: "summary_{who}_{YYYYMM}.json", image_png: "corridor_{who}_{YYYYMM}.png"}

modules:
  eclipse_lunation: {enable: true, include_solar: true, include_lunar: true, weight: 0.90, orb_override_deg: 9.0}
  vertex: {enable: true, acute_orb_deg: 2.0, decay_shape: gaussian}
  draconic: {enable: false, reference: north_node, weight_multiplier: 0.40}
  harmonics: {enable: false, include: [H1,H2,H3,H4,H5,H6,H7,H8,H9,H10,H11,H12], base_weight: 0.30}
