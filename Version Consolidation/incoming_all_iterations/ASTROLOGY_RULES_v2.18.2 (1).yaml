# ASTROLOGY_RULES_v2.18.2.yaml
# Unified master rules file — AP‑SUPER profile (Self + optional Composite/Synastry) 
# -------------------------------------------------------------------------------
# CHANGE LOG (v2.18.2)
# • Enforced "Synthetic Data Safeguard" across BOTH processing and visualization.
# • Added hard "Pre‑Run Checklist" with HALT/ASK policies per item.
# • Optimized smoothing/normalization path; clarified mean‑offset footnote rules.
# • Consolidated channel weights; added preflight auto‑enable with measurable lift.
# • Strengthened QA & provenance (file hashes, inputs, flags baked into outputs).
# • Performance: ephemeris slice prefetch, aspect caching, vectorized merges.
# • Vertex/Eclipse hooks retained; clarified orb decay and merging semantics.
# • Chart defaults: vizbands, labeled intensity bands, smart peak labeling + footnote.

meta:
  version: 2.18.2
  updated_utc: 2025-08-29T00:00:00Z
  profile: AP-SUPER
  apcfg: "[APCFG rules=YAML v2.18.2] house=whole node=true tz=America/New_York reloc=no sidereal=no stars=precess sf=on tob=est±0:45"
  source_of_truth:
    description: "Single rules file controls all logic; never use proxy data."
    required_files:
      - "Ephemeris 1900-2050 0.25 month steps.csv"
    optional_files:
      - "ephem_hourly_2025.csv"
      - "ASTROLOGY_INDIVIDUALS_v*.csv"
      - "Structured_Event_Log_v*.csv"
      - "*_Natal_Chart_Data_Placidus.csv"
      - "Chris_Remy_Synastry_Aspects.csv"
      - "Chris_Remy_Combined_Charts_Structured.csv"
    fail_policy:
      missing_required: "halt_channel"
      missing_optional: "disable_related_features_and_notify"

pre_run_checklist:
  # These checks execute BEFORE any run; non‑compliance follows the stated policy
  - id: consent_for_other_individuals
    description: "Explicit consent required for synastry & composite"
    require_true: execution_policy.include_individuals_only_when_requested
    on_fail: HALT_AND_PROMPT
  - id: mundane_disabled_by_default
    require_false: execution_policy.include_mundane_usa
    on_fail: FORCE_FALSE_AND_NOTE
  - id: ephemeris_available
    test: qa_validation.checks.ephemeris_slice_available
    on_fail: HALT_AND_PROMPT
  - id: natal_loaded
    test: qa_validation.checks.natal_data_loaded
    on_fail: HALT_AND_PROMPT
  - id: synthetic_policy_bound
    test: synthetic_data_safeguard.default == "disallow_without_consent"
    on_fail: HALT_AND_FIX
  - id: plotting_policy_wired
    test: visualization_policy.require_metadata_flags
    on_fail: HALT_AND_FIX

defaults:
  house_system: whole_sign
  true_node: true
  timezone: America/New_York
  relocations_enabled: false
  sidereal: false
  precessed_stars: true
  solar_fire_timing: true
  tob_uncertainty: "est±0:45"  # respect uncertainty in timing windows

channels:
  enabled_by_default:
    self: true
    external: true
    eclipse_lunation: true
  require_explicit_consent:
    synastry: true
    composite: true
  heavy_channels:
    network_synastry: false
    composite_multi: false
    declination_midpoints: false
    event_log: false
  optional_layers:
    harmonics_h1_h12: false
    draconic_overlays: false
  preflight_auto_enable:
    description: "Enable a candidate channel when the low‑cost preview shows objective lift."
    thresholds:
      corridor_power_delta: 0.12
      js_distance: 0.08
      flashpoint_lift: 0.10

aspects:
  set: [conjunction, opposition, square, trine, sextile, quincunx, semisquare, sesquisquare]
  orb_defaults_deg:
    luminaries: 8.0
    inner_planets: 6.0
    outer_planets: 5.0
    angles_points: 3.5  # ASC/DSC/MC/IC/Vertex/Nodes
  orb_overrides:
    vertex:
      conjunction: 2.0
      opposition: 2.0
    eclipse_lunation:
      conjunction: 9.0
      opposition: 9.0
  decay_shape: gaussian  # options: gaussian, triangular
  decay_params:
    gaussian_sigma_fraction_of_orb: 0.35

valence_map:
  positive: [trine, sextile]
  negative: [square, opposition, semisquare, sesquisquare]
  neutral: [conjunction, quincunx]

weights:
  channel:
    self: 1.00
    external: 0.85
    synastry: 0.95
    composite: 1.10
    eclipse_lunation: 0.90
    harmonics: 0.30
    draconic: 0.40
  harmonics:
    H1: 1.00
    H2: 0.70
    H3: 0.65
    H4: 0.60
    H5: 0.55
    H6: 0.50
    H7: 0.75
    H8: 0.55
    H9: 0.80
    H10: 0.50
    H11: 0.45
    H12: 0.60
  planets_points:
    Pluto: 1.30
    Saturn: 1.10
    Uranus: 1.15
    Neptune: 0.95
    Jupiter: 0.90
    Mars: 1.00
    Venus: 0.85
    Mercury: 0.85
    Sun: 1.05
    Moon: 0.90
    Vertex: 1.20
    Nodes: 1.10

windows:
  polling: hourly
  merge_same_sign:
    max_gap_hours: 6
    method: weighted_mean
  composite_windowing:
    method: intersection_then_union

normalization:
  method: minmax  # options: zscore|minmax|contrast_stretch
  minmax_target: [-1.0, 1.0]
  contrast_stretch:
    enabled: false
    lower_quantile: 0.05
    upper_quantile: 0.95
  zscore:
    enabled: false
    recenter_mean_to_zero: false  # keep mean offset; document in footnote
  footnote_mean_offset: true

smoothing:
  stage1_window_hours: 6      # rolling mean
  stage2_window_hours: 3      # rolling median
  savgol:
    enabled: false
    window_hours: 9
    polyorder: 2

bands:
  labels:
    pos_high: "High Positive Intensity"
    pos_med: "Medium Positive Intensity"
    pos_low: "Low Positive Intensity"
    neg_low: "Low Negative Intensity"
    neg_med: "Medium Negative Intensity"
    neg_high: "High Negative Intensity"
  thresholds:
    pos_low_min: 0.10
    pos_med_min: 0.35
    pos_high_min: 0.70
    neg_low_max: -0.10
    neg_med_max: -0.35
    neg_high_max: -0.70

flashpoints:
  peak_detection:
    prominence_min: 0.28
    min_separation_hours: 18
    neighborhood_hours: 12
  labeling:
    include_valence: true
    include_channels: true
    include_harmonics_when_active: true

plotting:
  style: vizbands
  annotate_bands: true
  annotate_peaks: smart  # auto label strongest peaks per week
  show_legend_groups:
    harmonics_collapsed: true
  footnote:
    show: true
    include:
      - test_types
      - calc_summary
      - orbs_and_thresholds
      - normalization_method
      - mean_offset_note
      - dataset_counts
      - channels_enabled

execution_policy:
  include_individuals_only_when_requested: true
  include_mundane_usa: false

synthetic_data_safeguard:
  default: "disallow_without_consent"
  when_real_data_unavailable:
    notify_user: true
    explain_meaning_loss: true
    ask_to_proceed: true
    watermark_outputs: true
  labels:
    watermark_text: "SYNTHETIC PREVIEW — Not ruleset‑driven"
  file_naming:
    suffix: "_SYNTHETIC"
  logging:
    record_reason: true
    record_user_choice: true

visualization_policy:
  require_metadata_flags: true
  if_synthetic:
    watermark: "SYNTHETIC PREVIEW — Not ruleset‑driven"
    filename_suffix: "_SYNTHETIC"
    footnote_append: "Synthetic preview; values illustrative only (no ephemeris/aspect engine). Accuracy loss: high for timing & magnitudes."
    palette_adjustment: dim
  if_raw:
    watermark: null
    filename_suffix: ""

qa_validation:
  checks:
    - name: ephemeris_slice_available
      action_on_fail: halt
    - name: natal_data_loaded
      action_on_fail: halt
    - name: weights_sum_reasonable
      bounds: [0.5, 5.0]
      action_on_fail: warn_and_continue
    - name: band_thresholds_consistent
      action_on_fail: fix_and_note
  provenance_logging:
    enabled: true
    include:
      - file_hashes
      - rules_version
      - start_end_timestamps
      - enabled_channels
      - normalization_and_smoothing

compliance_tests:
  - name: synthetic_must_be_watermarked
    fails_when: synthetic_run==true AND chart_watermark_missing
  - name: raw_must_not_be_watermarked
    fails_when: synthetic_run==false AND chart_watermark_present
  - name: suffix_alignment
    fails_when: (synthetic_run==true AND NOT filename_endswith("_SYNTHETIC")) OR (synthetic_run==false AND filename_endswith("_SYNTHETIC"))
  - name: footnote_contains_required_fields
    fails_when: missing_fields_in_footnote

performance:
  caching:
    ephemeris_slice_cache: true
    aspect_cache: true
  vectorization: true
  chunking:
    hours_per_chunk: 240
    overlap_hours: 6

outputs:
  corridor_csv: true
  flashpoints_csv: true
  summary_json: true
  image_png: true
  file_names:
    corridor_csv: "corridor_{who}_{YYYYMM}.csv"
    flashpoints_csv: "flashpoints_{who}_{YYYYMM}.csv"
    summary_json: "summary_{who}_{YYYYMM}.json"
    image_png: "corridor_{who}_{YYYYMM}.png"

modules:
  eclipse_lunation:
    enable: true
    include_solar: true
    include_lunar: true
    weight: 0.90
    orb_override_deg: 9.0
  vertex:
    enable: true
    acute_orb_deg: 2.0
    decay_shape: gaussian
  draconic:
    enable: false  # toggled per run
    reference: north_node
    weight_multiplier: 0.40
  harmonics:
    enable: false  # toggled per run
    include: [H1, H2, H3, H4, H5, H6, H7, H8, H9, H10, H11, H12]
    base_weight: 0.30

# END OF FILE
