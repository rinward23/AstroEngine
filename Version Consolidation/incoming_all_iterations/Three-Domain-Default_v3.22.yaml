---
meta:
  name: "Three-Domain Default"
  version: "v3.22"
  date: "2025-09-01"
  description: >
    Rolled-up default ruleset merging the Three-Domain framework, Temple Charter,
    Mediator layer, narrativity controls, normalized valence/enums, performance views,
    memoized joins, observability (no golden tests), and manifest hooks.
  authorship:
    created_by: "ChatGPT (GPT-5 Thinking)"
    notes: "Generated from user-approved architecture pass; excludes golden-test fixtures."
  compatibility:
    supersedes: ["Three_Domain_Ruleset_v3.21.2_with_Temple_Charter_and_Mediator.yaml"]
    archives_readonly: ["ASTROLOGY_RULES_v3.11_context_activation.yaml"]

defaults:
  active_ruleset: "three_domain"
  mode: "BRAINSTORM"   # Default interpretation profile; others: RUN_AP_LIGHT, RUN_AP_SUPER, RUN_AP_STRICT
  scope: "self"        # self | self+other | composite | all
  window: "all"        # Can be overridden per run (YYYY-MM-DD..YYYY-MM-DD)
  cache_policy:
    keep: 2            # keep current + last run
    strategy: "shelve_older_with_cache_log"
    show_cache_actions: true

doctrine:
  charter:
    immutable: true
    text: >
      Core program doctrines are always enforced unless explicitly overridden by the user.
      If a requested action violates a doctrine, the system must flag it with the violated
      clause, explain consequences, and require an explicit override token.
  enforcement:
    doctrine_lock: "strict"   # strict | warn | off
    require_explicit_override_token: true
    override_token_literal: "override: true"
    on_violation:
      behavior: "flag_and_pause"
      consequence_template: >
        Request violates doctrine: {clause}. Proceeding could degrade interpretability,
        narrative integrity, or ethical compliance. To continue anyway, include 'override: true'.

mediator:
  priority_order: ["doctrine", "domain", "channel", "submodule"]
  gating:
    domain_first: true
    lazy_load_non_passers: true
  transparency:
    log_rejections: true
    show_reasons: true

domains:
  # High-level processing domains; channels are routed here before loading heavy data.
  natal:
    enabled: true
    channels:
      - luminaries
      - personal_planets
      - social_planets
      - outer_planets
      - angles
      - nodes
      - chiron
      - asteroids_minor
      - benefics
      - malefics
  relationship:
    enabled: true
    channels:
      - composite_midpoint
      - davison
      - coalescent
      - composite_group_drv_asc
      - composite_drv_asc
  transits:
    enabled: true
    channels:
      - ephemeris_hits
      - synodic_cycles
      - retrograde_windows

features:
  narrativity:
    enabled: true
    orb_modifier_deg: 0.6     # applied post-gating, pre-aggregation
    smoothing:
      cluster_hours: 72
      downweight_minor_by: 0.25
    inclusion_strategy: "broaden_then_weight"
  valence:
    domain_defaults:
      natal: 0
      relationship: "±"
      transits: "±"
    channel_overrides:
      chiron: "-"
      benefics: "+"
      malefics: "-"
    inheritance:
      order: ["channel", "domain", "global_default"]
      global_default: 0
  harmonics:
    enabled: true
    map:
      H1: { favors: ["CON", "OPP", "SQR", "TRI", "SEX"], weight: 1.00 }
      H3: { favors: ["TRI"], weight: 1.08 }
      H4: { favors: ["SQR"], weight: 1.08 }
      H5: { favors: ["QUI"], weight: 1.10 }   # quintile (72°)
      H6: { favors: ["SEX"], weight: 1.06 }
      H7: { favors: ["SEPT"], weight: 1.05 }  # septile (~51.43°)
      H8: { favors: ["SQR", "TRI"], weight: 1.03 }
      H9: { favors: ["NOV"], weight: 1.05 }   # novile (40°)
      H10:{ favors: ["QUI"], weight: 1.06 }
      H11:{ favors: ["ELV"], weight: 1.04 }   # undecile (~32.73°)
      H12:{ favors: ["SEX"], weight: 1.03 }

enums:
  bodies:
    # Code: Full Name
    - SUN: "Sun"
    - MON: "Moon"
    - MER: "Mercury"
    - VEN: "Venus"
    - MAR: "Mars"
    - JUP: "Jupiter"
    - SAT: "Saturn"
    - URA: "Uranus"
    - NEP: "Neptune"
    - PLU: "Pluto"
    - CHI: "Chiron"
    - NOD: "Lunar Node (True/Mean)"
    - ASC: "Ascendant"
    - MC : "Midheaven"
  aspects:
    # Code: { degrees, major?, minor? }
    CON: { deg: 0,    major: true }
    OPP: { deg: 180,  major: true }
    TRI: { deg: 120,  major: true }
    SQR: { deg: 90,   major: true }
    SEX: { deg: 60,   major: true }
    QNX: { deg: 150,  major: false, minor: true } # quincunx
    QUI: { deg: 72,   major: false, minor: true } # quintile
    BQI: { deg: 144,  major: false, minor: true } # biquintile
    NOV: { deg: 40,   major: false, minor: true } # novile
    SEPT:{ deg: 51.43,major: false, minor: true } # septile
    ELV: { deg: 32.73,major: false, minor: true } # undecile
  systems:
    - natal
    - composite_midpoint
    - davison
    - coalescent
    - composite_group_drv_asc
    - composite_drv_asc
    - draconic_natal
    - harmonic_h1_to_h12
    - transits_ephemeris

schema:
  angle_notation:
    store:
      - "zodiacal"   # sign + degree
      - "decimal"    # 0..360
    compute_on_read:
      - "radians"
  timestamps:
    internal_tz: "UTC"
    preserve_source_tz_meta: true
  composite_taxonomy:
    allowed_types:
      - midpoint
      - davison
      - coalescent
      - group_drv_asc
      - drv_asc

data_sources:
  manifest_pointer: "/mnt/data/ASTROLOGY_MANIFEST_v2.0.yaml"
  require_manifest: true
  files_registered:
    - "/mnt/data/Chris_ALL_MODULES_MERGED.csv"
    - "/mnt/data/Remy_ALL_MODULES_MERGED.csv"
    - "/mnt/data/Chris_&_Remy_-_Composite_ALL_MERGED.csv"
    - "/mnt/data/Chris_Remy_Harmonics_1-12_with_numbers.csv"
    - "/mnt/data/Chris_Remy_Draconic_Natal_Structured.csv"
    - "/mnt/data/CV_Natal_Chart.csv"
    - "/mnt/data/CV_CR_Composite_Midpoints.csv"
    - "/mnt/data/MASTER_Ephemeris_0000-3000_merged.csv"
    - "/mnt/data/MASTER_Ephemeris_0000-3000_merged.sqlite"
    - "/mnt/data/ASTRO_ENGINE.sqlite"
  index_policy:
    checksum_strategy: "compute_on_index"
    schema_version: "1.5.0"
    require_headers: true
    solarfire_parser:
      enabled: true
      label_detection: "broad"
      allow_abbrev: true
      keep_raw_text_columns: true

runtime:
  gating_flow:
    order: ["mediator", "domain", "channel", "submodule"]
    load_strategy:
      - "gate_before_join"
      - "memoize_window_joins"
  memoization:
    windows_cache:
      enabled: true
      keys: ["window", "scope", "mode"]
      stores:
        - "natal_x_ephemeris_hits"
        - "composite_x_ephemeris_hits"
  modes:
    RUN_AP_LIGHT:
      narrativity_enabled: true
      intensity: "light"
      use_minor_aspects: true
    RUN_AP_SUPER:
      narrativity_enabled: true
      intensity: "super"
      use_minor_aspects: true
    RUN_AP_STRICT:
      narrativity_enabled: false
      intensity: "strict"
      use_minor_aspects: false
  scoring:
    layers:
      orb_closeness_weight: 0.35
      aspect_power_weight: 0.30
      context_weight: 0.20
      jungian_resonance_weight: 0.15
    clamp_range: [0.0, 1.0]
  jungian_overlay:
    enabled: true
    crosswalk_source: "internal"
    archetypes:
      - Shadow
      - Anima_Animus
      - Self
      - Hero
      - Wise_Old_Young
      - Trickster
    stitching:
      cluster_hours: 72
      paragraph_style: "archetypal_composite"

db:
  engine: "sqlite"
  primary_files:
    - "/mnt/data/ASTRO_ENGINE.sqlite"
    - "/mnt/data/MASTER_Ephemeris_0000-3000_merged.sqlite"
  views:
    v_run_ephemeris:
      signature: "v_run_ephemeris(window)"
      fields: ["date", "body", "sign", "rx", "exact_hits"]
      note: "Thin transit slice limited to active window"
    v_synodic_hits:
      signature: "v_synodic_hits(window)"
      fields: ["date", "body_a", "body_b", "aspect", "orb", "angle"]
      note: "Derived aspects of transits to natal/composite"
    v_jungian_markers:
      signature: "v_jungian_markers(window)"
      fields: ["date", "archetype", "intensity", "evidence_ids"]
      note: "Pre-scored archetypal signatures for narrative stitching"
  indices:
    - table: "aspects"
      columns: ["entity_id", "body_a", "body_b", "exact_deg"]
    - table: "events"
      columns: ["date_ts"]
    - table: "composites"
      columns: ["pair_id", "type"]

observability:
  post_run_report:
    enabled: true
    include:
      - "active_domains_channels"
      - "counts_per_view"
      - "time_per_join"
      - "cache_hits"
      - "top10_rule_contributors"
  logging:
    level: "INFO"
    redact_personal_fields: true
    show_reasons: true
  qa:
    schema_lints: ["enum_check", "null_check", "angle_range_check", "timezone_tag_check"]
    # Intentionally excluding golden tests / known-truth fixtures per user request.

compatibility:
  archival_rulesets:
    v3_11:
      path: "ASTROLOGY_RULES_v3.11_context_activation.yaml"
      status: "archived_readonly"
      retrieval_requires: "explicit_user_command"

changelog:
  - 2025-09-01:
      version: "v3.22"
      adds:
        - Unified narrativity knob (orb_modifier_deg) + smoothing
        - Normalized valence with inheritance rules
        - Mediator conflict order + explicit override UX
        - SQLite run-views + indices + memoized window joins
        - Observability post-run report (no golden tests)
        - Manifest cross-check + SolarFire parser wiring
      removes:
        - Golden-test fixtures / “known truths”
      notes:
        - Three-Domain ruleset is now the default for all runs.
...
