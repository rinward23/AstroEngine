<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AstroEngine Copilot</title>
<style>
body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 1rem; background: #0f1224; color: #f5f6fa; }
#messages { max-height: 520px; overflow-y: auto; padding: 0.5rem; border: 1px solid #272a4b; border-radius: 8px; background: #141836; }
.message { margin-bottom: 1rem; padding: 0.6rem 0.75rem; border-radius: 6px; }
.message.user { background: #1e2344; border-left: 3px solid #c9973b; }
.message.assistant { background: #16294f; border-left: 3px solid #0f9960; }
#composer { display: flex; gap: 0.5rem; margin-top: 1rem; }
#composer textarea { flex: 1; min-height: 60px; border-radius: 6px; border: 1px solid #2d3256; background: #1b2040; color: #f5f6fa; padding: 0.5rem; }
#composer button { padding: 0.6rem 1rem; border: none; border-radius: 6px; background: #c9973b; color: #101321; font-weight: 600; cursor: pointer; }
#status { margin-top: 0.5rem; font-size: 0.85rem; color: #9aa5ff; }
</style>
</head>
<body>
<h1>AstroEngine Copilot</h1>
<div id="messages"></div>
<div id="status"></div>
<form id="composer">
  <textarea id="prompt" placeholder="Ask the copilot to run diagnostics, tail logs, or explain an endpoint..."></textarea>
  <button>Send</button>
</form>
<script>
const messagesEl = document.getElementById('messages');
const statusEl = document.getElementById('status');
const composer = document.getElementById('composer');
const promptEl = document.getElementById('prompt');

function append(role, text) {
  const div = document.createElement('div');
  div.className = 'message ' + role;
  div.innerHTML = '<strong>' + role + '</strong><br />' + text.replace(/\n/g, '<br />');
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function refreshStatus() {
  const stats = await window.pywebview.api.copilot_status();
  statusEl.textContent = `Tokens today: ${stats.tokens_used_today}/${stats.daily_limit} · API ${stats.client_available ? 'ready' : 'not configured'}`;
}

composer.addEventListener('submit', async (event) => {
  event.preventDefault();
  const text = promptEl.value.trim();
  if (!text) return;
  append('user', text);
  promptEl.value = '';
  append('assistant', '… running tools / awaiting response …');
  const nodes = messagesEl.querySelectorAll('.message.assistant');
  const placeholder = nodes[nodes.length - 1];
  const result = await window.pywebview.api.copilot_send(text);
  placeholder.innerHTML = '<strong>assistant</strong><br />' + result.response.replace(/\n/g, '<br />');
  refreshStatus();
});

window.AstroEngine = window.AstroEngine || {};
window.AstroEngine.setApiStatus = function(online) {
  statusEl.style.borderBottom = online ? '3px solid #0f9960' : '3px solid #ff6b6b';
};

refreshStatus();
</script>
</body>
</html>
